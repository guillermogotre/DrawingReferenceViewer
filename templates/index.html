<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drawing Reference Viewer</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% raw %}
<div id="app">
    <div class="viewer-container" ref="viewer" @wheel="handleWheel" @gesturestart="handleGestureStart" @gesturechange="handleGestureChange" @gestureend="handleGestureEnd" @mousedown="startDrag" @mousemove="onDrag" @mouseup="stopDrag" @mouseleave="stopDrag" @dblclick="resetTransform">
        <transition name="fade"><div v-if="isLoading" class="loader-overlay"><div class="spinner"></div></div></transition>
        <div class="transform-layer" :style="layerStyle">
            <img v-if="currentImage" :src="currentUrl" class="main-img" :class="{ 'grayscale': grayscaleMode, 'opacity-0': isLoading }" :style="imageStyle" @load="onImageLoaded" @error="onImageError">
            <div v-else-if="!isLoading" class="text-gray-500 text-2xl text-center select-none"><p>Press <span class="text-blue-400 font-bold">SPACE</span> to start.</p></div>
        </div>
    </div>
    <div class="overlay-ui flex flex-col justify-between p-4">
        <div class="flex justify-between items-start">
            <div class="ui-element flex gap-4 items-center">
                <button @click="showSettings = !showSettings" class="ui-btn">‚öôÔ∏è Config</button>
                <button @click="showFavorites = !showFavorites" class="ui-btn text-yellow-400">‚òÖ Favorites ({{favorites.length}})</button>
                <div class="text-xl font-mono font-bold text-white w-16 text-center cursor-default">{{ formatTime(timer) }}</div>
            </div>
            <div class="ui-element text-xs text-gray-300 flex flex-col items-end" v-if="currentImage">
                <span class="opacity-50">{{ currentImage.folder_root }}</span>
                <span class="font-bold text-white text-sm truncate max-w-md">{{ currentImage.filename }}</span>
                <div class="text-blue-300 mt-1 text-[10px] flex items-center gap-1">
                    <span v-if="!isEditingIndex" @click="startEditingIndex" class="cursor-pointer hover:text-white border-b border-transparent hover:border-blue-300 transition-colors font-bold" title="Click to jump to number">{{ currentIndex + 1 }}</span>
                    <input v-else ref="indexInput" type="number" v-model="tempIndexValue" @blur="commitIndexChange" @keydown.enter="commitIndexChange" class="w-12 bg-gray-800 text-white border border-blue-500 rounded px-1 text-center no-spinners outline-none text-[10px]">
                    <span>/ {{ siblings.length }} (Folder)</span>
                </div>
            </div>
        </div>
        <div class="flex justify-center mb-4">
            <div class="ui-element flex gap-2 items-center shadow-xl">
                <div class="flex gap-1 mr-2 border-r border-gray-600 pr-2">
                    <button @click="goHistory(-1)" :disabled="historyIndex <= 0" title="Back" class="ui-btn text-xl text-yellow-400">‚Ü∂</button>
                    <button @click="goHistory(1)" :disabled="historyIndex >= history.length - 1" title="Forward" class="ui-btn text-xl text-yellow-400">‚Ü∑</button>
                </div>
                <div class="flex gap-1 mr-4 border-r border-gray-600 pr-4">
                    <button @click="navSibling(-1)" title="Previous" class="ui-btn text-xl">‚óÄ</button>
                    <button @click="navSibling(1)" title="Next" class="ui-btn text-xl">‚ñ∂</button>
                </div>
                <button @click="togglePlay" title="Pause" class="ui-btn text-xl min-w-[40px]">{{ isPaused ? '‚ñ∂Ô∏è' : '‚è∏' }}</button>
                <button @click="loadRandomImage" title="Random (Space)" class="ui-btn btn-primary shadow-lg"><span>üé≤ Random</span></button>
                <div class="w-px h-6 bg-gray-600 mx-2"></div>
                <button @click="toggleFavorite" title="Favorite (M)" class="ui-btn text-xl transition-colors" :class="isCurrentFavorite ? 'text-red-500' : 'text-gray-400'">{{ isCurrentFavorite ? '‚ù§Ô∏è' : 'ü§ç' }}</button>
                <div class="w-px h-6 bg-gray-600 mx-2"></div>
                <button @click="flipH = !flipH" title="Flip (F)" class="ui-btn font-bold">‚Üî</button>
                <button @click="rotateRight" title="Rotate (R)" class="ui-btn font-bold">‚ü≥</button>
                <button @click="grayscaleMode = !grayscaleMode" title="B/W (G)" class="ui-btn font-bold" :class="grayscaleMode ? 'bg-white text-black hover:bg-gray-200' : ''">BW</button>
            </div>
        </div>
    </div>
    <transition name="fade">
        <div v-if="showSettings" class="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-10 backdrop-blur-sm">
            <div class="bg-gray-800 p-6 rounded-xl max-w-3xl w-full h-[80vh] flex flex-col shadow-2xl border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4 shrink-0">
                    <h2 class="text-2xl font-bold text-white">Libraries</h2>
                    <button @click="refreshLibrary" :disabled="isRefreshing" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded flex items-center gap-2 transition-colors border border-gray-600">
                        <span v-if="isRefreshing">‚è≥ Scanning...</span><span v-else>üîÑ Refresh Changes</span>
                    </button>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-white text-2xl ml-4">‚úï</button>
                </div>
                <div class="flex flex-col gap-3 mb-4 shrink-0">
                    <input type="text" v-model="searchQuery" placeholder="üîç Search folder..." class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400 uppercase font-bold">Showing {{ filteredFolders.length }} of {{ folders.length }}</span>
                        <label class="flex items-center gap-2 cursor-pointer text-sm text-blue-300 hover:text-white select-none"><input type="checkbox" @change="toggleVisibleFolders" :checked="areAllVisibleSelected"> {{ areAllVisibleSelected ? 'Deselect Visible' : 'Select Visible' }}</label>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll bg-gray-900/50 rounded border border-gray-700 p-2">
                    <div v-if="filteredFolders.length === 0" class="text-center text-gray-500 py-8">No folders match your search.</div>
                    <label v-for="folder in filteredFolders" :key="folder" @dblclick.prevent="selectOnly(folder)" title="Double click to select ONLY this folder" class="flex items-start gap-3 p-3 border-b border-gray-700/50 hover:bg-gray-700 cursor-pointer transition-colors last:border-0 select-none">
                        <input type="checkbox" :value="folder" v-model="selectedFolders" class="mt-1 w-4 h-4 accent-blue-500 shrink-0"><span class="text-sm text-gray-200 break-words leading-snug">{{ folder }}</span>
                    </label>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t border-gray-700 shrink-0 mt-4">
                    <button @click="showSettings = false" class="text-gray-400 hover:text-white px-4 py-2">Cancel</button>
                    <button @click="saveAndStart" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-2 rounded font-bold shadow-lg">Start</button>
                </div>
            </div>
        </div>
    </transition>
    <transition name="fade">
        <div v-if="showFavorites" class="absolute inset-0 bg-black/90 z-50 flex flex-col p-6 backdrop-blur-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-yellow-400">‚ù§Ô∏è Your Favorites</h2>
                <button @click="showFavorites = false" class="text-white hover:text-red-400 text-4xl">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto rounded-xl bg-gray-900/50 border border-gray-800 p-4">
                <div v-if="favorites.length === 0" class="h-full flex flex-col items-center justify-center text-gray-500"><div class="text-6xl mb-4">üíî</div><p class="text-xl">You don't have any favorites yet.</p></div>
                <div v-else class="fav-grid">
                    <div v-for="favPath in favorites" :key="favPath" class="fav-item group" @click="loadFavorite(favPath)">
                        <img :src="`/media/${favPath}`" loading="lazy" alt="Reference">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><span class="text-white font-bold">Open</span></div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</div>
{% endraw %}

<script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>